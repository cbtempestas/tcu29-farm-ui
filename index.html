<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCu29 Farm | Stake LP, Earn USDT</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 40px 0 30px;
        }
        header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            background: linear-gradient(90deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        header p {
            color: #8892b0;
            font-size: 0.95rem;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        .stat {
            text-align: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f39c12;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #8892b0;
            margin-top: 4px;
        }
        .apr-highlight {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.2), rgba(231, 76, 60, 0.2));
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .apr-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2ecc71;
        }
        .apr-label {
            color: #8892b0;
            font-size: 0.9rem;
        }
        .section-title {
            font-size: 1rem;
            margin-bottom: 16px;
            color: #fff;
        }
        .input-group {
            margin-bottom: 16px;
        }
        .input-wrapper {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-wrapper input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 16px;
            font-size: 1.1rem;
            color: #fff;
            outline: none;
        }
        .input-wrapper input::placeholder {
            color: #5a6a8a;
        }
        .max-btn {
            background: rgba(243, 156, 18, 0.2);
            border: none;
            padding: 16px 20px;
            color: #f39c12;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .max-btn:hover {
            background: rgba(243, 156, 18, 0.3);
        }
        .balance-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #8892b0;
            margin-top: 8px;
        }
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }
        .btn-primary {
            background: linear-gradient(90deg, #f39c12, #e74c3c);
            color: #fff;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(243, 156, 18, 0.4);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .pending-rewards {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 16px;
        }
        .pending-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2ecc71;
        }
        .pending-label {
            font-size: 0.85rem;
            color: #8892b0;
        }
        .connect-prompt {
            text-align: center;
            padding: 40px 20px;
        }
        .connect-prompt p {
            color: #8892b0;
            margin-bottom: 20px;
        }
        .links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .links a {
            color: #8892b0;
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s;
        }
        .links a:hover {
            color: #f39c12;
        }
        .status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }
        .status.success {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        .status.error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        .status.pending {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
        }
        .hidden {
            display: none;
        }
        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>TCu29 Farm</h1>
            <p>Stake TCu29/USDT LP → Earn USDT</p>
        </header>

        <div class="card">
            <div class="apr-highlight">
                <div class="apr-value" id="apr">---%</div>
                <div class="apr-label">Current APR</div>
            </div>
            <div class="stats-grid">
                <div class="stat">
                    <div class="stat-value" id="tvl">$---</div>
                    <div class="stat-label">Total Value Locked</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="daily-rewards">---</div>
                    <div class="stat-label">USDT / Day</div>
                </div>
            </div>
        </div>

        <div id="connect-section" class="card">
            <div class="connect-prompt">
                <p>Connect your wallet to stake LP tokens and earn USDT rewards</p>
                <button class="btn btn-primary" id="connect-btn">Connect Wallet</button>
            </div>
        </div>

        <div id="stake-section" class="card hidden">
            <div id="status-msg" class="status hidden"></div>

            <div class="pending-rewards">
                <div class="pending-value" id="pending-rewards">0.0000 USDT</div>
                <div class="pending-label">Pending Rewards</div>
            </div>
            <button class="btn btn-secondary" id="harvest-btn">Harvest Rewards</button>

            <h3 class="section-title">Your Position</h3>
            <div class="stats-grid">
                <div class="stat">
                    <div class="stat-value" id="user-staked">0.00</div>
                    <div class="stat-label">LP Staked</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="user-share">0.00%</div>
                    <div class="stat-label">Pool Share</div>
                </div>
            </div>

            <h3 class="section-title">Stake LP Tokens</h3>
            <div class="input-group">
                <div class="input-wrapper">
                    <input type="number" id="deposit-amount" placeholder="0.0" step="any">
                    <button class="max-btn" id="deposit-max-btn">MAX</button>
                </div>
                <div class="balance-row">
                    <span>Balance:</span>
                    <span id="lp-balance">0.00 LP</span>
                </div>
            </div>
            <button class="btn btn-primary" id="deposit-btn">Deposit</button>

            <h3 class="section-title">Withdraw LP Tokens</h3>
            <div class="input-group">
                <div class="input-wrapper">
                    <input type="number" id="withdraw-amount" placeholder="0.0" step="any">
                    <button class="max-btn" id="withdraw-max-btn">MAX</button>
                </div>
                <div class="balance-row">
                    <span>Staked:</span>
                    <span id="staked-balance">0.00 LP</span>
                </div>
            </div>
            <button class="btn btn-secondary" id="withdraw-btn">Withdraw</button>
        </div>

        <div class="links">
            <a href="https://pancakeswap.finance/add/0x5b0B5c848a843c83c20dcfa25CDe6E122898a614/0x55d398326f99059fF775485246999027B3197955" target="_blank">Get LP Tokens ↗</a>
            <a href="https://bscscan.com/address/0x7Fe0EDcCd50A704D78EdA999607CA9B61BCafD0A#code" target="_blank">Contract ↗</a>
            <a href="https://dexscreener.com/bsc/0xc4a13d9c061bb6fc254cc31d4737c6d5427b3aa8" target="_blank">Chart ↗</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
    <script>
        // Contract addresses
        const FARM_ADDRESS = "0x7Fe0EDcCd50A704D78EdA999607CA9B61BCafD0A";
        const LP_TOKEN_ADDRESS = "0xC4A13D9C061bb6FC254cc31d4737C6d5427B3aa8";
        const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";

        // ABIs
        const FARM_ABI = [
            "function deposit(uint256 pid, uint256 amount) external",
            "function withdraw(uint256 pid, uint256 amount) external",
            "function harvest(uint256 pid) external",
            "function pendingReward(uint256 pid, address user) view returns (uint256)",
            "function userInfo(uint256 pid, address user) view returns (uint256 amount, uint256 rewardDebt)",
            "function getFarmInfo() view returns (uint256 totalStaked, uint256 rewardsPerDay, uint256 rewardsRemaining, uint256 endTime)",
            "function rewardPerSecond() view returns (uint256)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address account) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        const LP_ABI = [
            ...ERC20_ABI,
            "function totalSupply() view returns (uint256)"
        ];

        // State
        let provider, signer, userAddress;
        let farm, lpToken, usdt;

        // DOM elements
        const connectBtn = document.getElementById('connect-btn');
        const connectSection = document.getElementById('connect-section');
        const stakeSection = document.getElementById('stake-section');
        const statusMsg = document.getElementById('status-msg');

        // Initialize
        async function init() {
            await updateFarmStats();
            setInterval(updateFarmStats, 30000);
        }

        // Connect wallet
        connectBtn.addEventListener('click', async () => {
            try {
                if (!window.ethereum) {
                    showStatus('Please install MetaMask or another Web3 wallet', 'error');
                    return;
                }

                provider = new ethers.BrowserProvider(window.ethereum);

                // Request account access
                await provider.send("eth_requestAccounts", []);

                // Check network (BSC = 56)
                const network = await provider.getNetwork();
                if (network.chainId !== 56n) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x38' }],
                        });
                        provider = new ethers.BrowserProvider(window.ethereum);
                    } catch (switchError) {
                        showStatus('Please switch to BSC network', 'error');
                        return;
                    }
                }

                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // Initialize contracts
                farm = new ethers.Contract(FARM_ADDRESS, FARM_ABI, signer);
                lpToken = new ethers.Contract(LP_TOKEN_ADDRESS, LP_ABI, signer);
                usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);

                // Update UI
                connectSection.classList.add('hidden');
                stakeSection.classList.remove('hidden');

                await updateUserInfo();
                setInterval(updateUserInfo, 10000);

            } catch (error) {
                console.error(error);
                showStatus('Failed to connect: ' + error.message, 'error');
            }
        });

        // Update farm statistics
        async function updateFarmStats() {
            try {
                const readProvider = new ethers.JsonRpcProvider('https://bsc-dataseed.binance.org/');
                const farmRead = new ethers.Contract(FARM_ADDRESS, FARM_ABI, readProvider);
                const lpRead = new ethers.Contract(LP_TOKEN_ADDRESS, LP_ABI, readProvider);
                const usdtRead = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, readProvider);

                const [farmInfo, lpSupply, usdtInPool] = await Promise.all([
                    farmRead.getFarmInfo(),
                    lpRead.totalSupply(),
                    usdtRead.balanceOf(LP_TOKEN_ADDRESS)
                ]);

                const [totalStaked, rewardsPerDay] = farmInfo;

                // Calculate LP price (2 * USDT reserve / total supply)
                const poolTVL = usdtInPool * 2n;
                const lpPrice = lpSupply > 0n ? poolTVL * BigInt(1e18) / lpSupply : 0n;

                // Calculate TVL
                const tvl = totalStaked * lpPrice / BigInt(1e18);

                // Calculate APR
                const annualRewards = rewardsPerDay * 365n;
                const apr = tvl > 0n ? (annualRewards * 100n * BigInt(1e18)) / tvl : 0n;

                // Update UI
                document.getElementById('tvl').textContent = '$' + formatNumber(ethers.formatUnits(tvl, 18), 2);
                document.getElementById('daily-rewards').textContent = formatNumber(ethers.formatUnits(rewardsPerDay, 18), 2);
                document.getElementById('apr').textContent = formatNumber(ethers.formatUnits(apr, 18), 0) + '%';

            } catch (error) {
                console.error('Failed to update farm stats:', error);
            }
        }

        // Update user info
        async function updateUserInfo() {
            if (!userAddress) return;

            try {
                const [userInfo, lpBalance, pending, farmInfo] = await Promise.all([
                    farm.userInfo(0, userAddress),
                    lpToken.balanceOf(userAddress),
                    farm.pendingReward(0, userAddress),
                    farm.getFarmInfo()
                ]);

                const [userStaked] = userInfo;
                const [totalStaked] = farmInfo;

                const share = totalStaked > 0n ? (userStaked * 10000n / totalStaked) : 0n;

                document.getElementById('user-staked').textContent = formatNumber(ethers.formatUnits(userStaked, 18), 4);
                document.getElementById('staked-balance').textContent = formatNumber(ethers.formatUnits(userStaked, 18), 4) + ' LP';
                document.getElementById('lp-balance').textContent = formatNumber(ethers.formatUnits(lpBalance, 18), 4) + ' LP';
                document.getElementById('user-share').textContent = (Number(share) / 100).toFixed(2) + '%';
                document.getElementById('pending-rewards').textContent = formatNumber(ethers.formatUnits(pending, 18), 6) + ' USDT';

                // Store for max buttons
                window.userLpBalance = lpBalance;
                window.userStaked = userStaked;

            } catch (error) {
                console.error('Failed to update user info:', error);
            }
        }

        // Deposit
        document.getElementById('deposit-btn').addEventListener('click', async () => {
            const amount = document.getElementById('deposit-amount').value;
            if (!amount || parseFloat(amount) <= 0) {
                showStatus('Enter an amount', 'error');
                return;
            }

            try {
                const amountWei = ethers.parseUnits(amount, 18);

                // Check allowance
                const allowance = await lpToken.allowance(userAddress, FARM_ADDRESS);
                if (allowance < amountWei) {
                    showStatus('Approving LP tokens...', 'pending');
                    const approveTx = await lpToken.approve(FARM_ADDRESS, amountWei);
                    await approveTx.wait();
                }

                showStatus('Depositing...', 'pending');
                const tx = await farm.deposit(0, amountWei);
                await tx.wait();

                showStatus('Deposit successful!', 'success');
                document.getElementById('deposit-amount').value = '';
                await updateUserInfo();
                await updateFarmStats();

            } catch (error) {
                console.error(error);
                showStatus('Deposit failed: ' + (error.reason || error.message), 'error');
            }
        });

        // Withdraw
        document.getElementById('withdraw-btn').addEventListener('click', async () => {
            const amount = document.getElementById('withdraw-amount').value;
            if (!amount || parseFloat(amount) <= 0) {
                showStatus('Enter an amount', 'error');
                return;
            }

            try {
                const amountWei = ethers.parseUnits(amount, 18);

                showStatus('Withdrawing...', 'pending');
                const tx = await farm.withdraw(0, amountWei);
                await tx.wait();

                showStatus('Withdraw successful!', 'success');
                document.getElementById('withdraw-amount').value = '';
                await updateUserInfo();
                await updateFarmStats();

            } catch (error) {
                console.error(error);
                showStatus('Withdraw failed: ' + (error.reason || error.message), 'error');
            }
        });

        // Harvest
        document.getElementById('harvest-btn').addEventListener('click', async () => {
            try {
                showStatus('Harvesting rewards...', 'pending');
                const tx = await farm.harvest(0);
                await tx.wait();

                showStatus('Harvest successful!', 'success');
                await updateUserInfo();

            } catch (error) {
                console.error(error);
                showStatus('Harvest failed: ' + (error.reason || error.message), 'error');
            }
        });

        // Max buttons
        document.getElementById('deposit-max-btn').addEventListener('click', () => {
            if (window.userLpBalance) {
                document.getElementById('deposit-amount').value = ethers.formatUnits(window.userLpBalance, 18);
            }
        });

        document.getElementById('withdraw-max-btn').addEventListener('click', () => {
            if (window.userStaked) {
                document.getElementById('withdraw-amount').value = ethers.formatUnits(window.userStaked, 18);
            }
        });

        // Helpers
        function showStatus(message, type) {
            statusMsg.textContent = message;
            statusMsg.className = 'status ' + type;
            statusMsg.classList.remove('hidden');

            if (type === 'success') {
                setTimeout(() => statusMsg.classList.add('hidden'), 5000);
            }
        }

        function formatNumber(num, decimals) {
            const n = parseFloat(num);
            if (isNaN(n)) return '0';
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(2) + 'K';
            return n.toFixed(decimals);
        }

        // Handle account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => window.location.reload());
            window.ethereum.on('chainChanged', () => window.location.reload());
        }

        // Start
        init();
    </script>
</body>
</html>
