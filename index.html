<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCu29 Farm | Copper-Backed Yield</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Stake TCu29-USDT LP tokens and earn USDT rewards. TCu29 is a copper-backed digital asset on BNB Chain with real yield farming.">
    <meta name="keywords" content="TCu29, copper, yield farming, BSC, BNB Chain, USDT, staking, DeFi, copper-backed">
    <meta name="author" content="TCu29">
    <link rel="canonical" href="https://cbtempestas.github.io/tcu29-farm-ui/">

    <!-- Open Graph / Social -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="TCu29 Farm | Copper-Backed Yield">
    <meta property="og:description" content="Stake TCu29-USDT LP tokens and earn USDT rewards. TCu29 is a copper-backed digital asset on BNB Chain.">
    <meta property="og:image" content="https://www.tcu29.io/lovable-uploads/StandingTCu29.png">
    <meta property="og:url" content="https://cbtempestas.github.io/tcu29-farm-ui/">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="TCu29 Farm | Copper-Backed Yield">
    <meta name="twitter:description" content="Stake TCu29-USDT LP tokens and earn USDT rewards.">
    <meta name="twitter:image" content="https://www.tcu29.io/lovable-uploads/StandingTCu29.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: #1e3a5f;
        }
        .container {
            max-width: 520px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 30px 0 20px;
        }
        .logo {
            width: 360px;
            height: 360px;
            margin: 0 auto 20px;
            object-fit: contain;
            filter: drop-shadow(0 8px 24px rgba(184, 115, 51, 0.4));
        }
        header h1 {
            font-size: 1.8rem;
            margin-bottom: 6px;
            color: #1e3a5f;
        }
        header h1 span {
            color: #b87333;
        }
        header p {
            color: #64748b;
            font-size: 0.9rem;
        }
        .card {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }
        .apr-card {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: #fff;
            text-align: center;
            padding: 28px 24px;
        }
        .apr-value {
            font-size: 3rem;
            font-weight: 700;
            color: #4ade80;
            line-height: 1;
        }
        .apr-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-top: 8px;
        }
        .tvl-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
        }
        .tvl-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
        }
        .tvl-value {
            color: #fff;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .copper-card {
            background: linear-gradient(135deg, #fef3e2 0%, #fde8d0 100%);
            border: 1px solid #f5d5b5;
        }
        .copper-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .copper-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #92400e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .copper-link {
            font-size: 0.8rem;
            color: #b87333;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .copper-link:hover {
            text-decoration: underline;
        }
        .copper-price {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 12px;
        }
        .copper-price-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e3a5f;
        }
        .copper-price-change {
            font-size: 0.95rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
        }
        .copper-price-change.up {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }
        .copper-price-change.down {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }
        .copper-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(146, 64, 14, 0.15);
        }
        .copper-stat {
            text-align: center;
        }
        .copper-stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e3a5f;
        }
        .copper-stat-label {
            font-size: 0.75rem;
            color: #92400e;
            margin-top: 2px;
        }
        .price-chart-container {
            margin-top: 12px;
            background: #fff;
            border-radius: 8px;
            padding: 12px;
        }
        .price-chart-container canvas {
            width: 100%;
            height: 160px;
            display: block;
        }
        .why-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .why-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .why-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        .why-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 4px;
        }
        .why-desc {
            font-size: 0.75rem;
            color: #64748b;
            line-height: 1.4;
        }
        .connect-prompt {
            text-align: center;
            padding: 30px 20px;
        }
        .connect-prompt p {
            color: #64748b;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #b87333, #cd7f32);
            color: #fff;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(184, 115, 51, 0.4);
        }
        .btn-secondary {
            background: #f1f5f9;
            color: #1e3a5f;
            border: 1px solid #e2e8f0;
        }
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .section-title {
            font-size: 0.9rem;
            margin-bottom: 12px;
            color: #1e3a5f;
            font-weight: 600;
        }
        .input-group {
            margin-bottom: 16px;
        }
        .input-wrapper {
            display: flex;
            background: #f8fafc;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .input-wrapper input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 16px;
            font-size: 1.1rem;
            color: #1e3a5f;
            outline: none;
        }
        .input-wrapper input::placeholder {
            color: #94a3b8;
        }
        .max-btn {
            background: rgba(184, 115, 51, 0.1);
            border: none;
            padding: 16px 20px;
            color: #b87333;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .max-btn:hover {
            background: rgba(184, 115, 51, 0.2);
        }
        .balance-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 8px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        .stat {
            text-align: center;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e3a5f;
        }
        .stat-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 4px;
        }
        .pending-rewards {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 16px;
        }
        .pending-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #16a34a;
        }
        .pending-label {
            font-size: 0.85rem;
            color: #64748b;
        }
        .status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }
        .status.success {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }
        .status.error {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        .status.pending {
            background: rgba(184, 115, 51, 0.1);
            color: #b87333;
        }
        .hidden {
            display: none;
        }
        .links {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        .links a {
            color: #64748b;
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s;
        }
        .links a:hover {
            color: #b87333;
        }
        .footer {
            text-align: center;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }
        .footer a {
            color: #b87333;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }
            .why-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img class="logo" src="https://www.tcu29.io/lovable-uploads/StandingTCu29.png" alt="TCu29">
            <h1>Earn USDT with <span>Copper</span></h1>
            <p>Stake TCu29-USDT Tokens - Earn Stable Coin</p>
        </header>

        <div class="card apr-card">
            <div class="apr-value" id="apr">---%</div>
            <div class="apr-label">Annual Percentage Rate</div>
            <div class="tvl-row">
                <span class="tvl-label">Total Value Locked:</span>
                <span class="tvl-value" id="tvl">$---</span>
            </div>
        </div>

        <div class="card copper-card">
            <div class="copper-header">
                <span class="copper-title">Copper Market</span>
                <a href="https://www.google.com/finance/quote/HGW00:COMEX" target="_blank" class="copper-link">
                    Live Chart
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M7 17L17 7M17 7H7M17 7V17"/>
                    </svg>
                </a>
            </div>
            <div class="copper-price">
                <span class="copper-price-value" id="copper-price">$---.--</span>
                <span class="copper-price-change up" id="copper-change">per lb</span>
            </div>
            <div class="price-chart-container">
                <canvas id="price-chart" width="400" height="160"></canvas>
            </div>
        </div>

        <div class="why-section">
            <div class="why-item">
                <div class="why-icon">&#x26A1;</div>
                <div class="why-title">High Yield</div>
                <div class="why-desc">Earn USDT rewards on your staked LP position</div>
            </div>
            <div class="why-item">
                <div class="why-icon">&#x1F3AF;</div>
                <div class="why-title">Asset-Backed</div>
                <div class="why-desc">TCu29 is backed by real physical copper</div>
            </div>
            <div class="why-item">
                <div class="why-icon">&#x1F512;</div>
                <div class="why-title">Verified</div>
                <div class="why-desc">Contract verified on BSCScan</div>
            </div>
            <div class="why-item">
                <div class="why-icon">&#x1F4CA;</div>
                <div class="why-title">Transparent</div>
                <div class="why-desc">On-chain reserves, quarterly audits</div>
            </div>
        </div>

        <div id="connect-section" class="card" style="margin-top: 16px;">
            <div class="connect-prompt">
                <p>Connect your wallet to stake TCu29/USDT LP tokens</p>
                <button class="btn btn-primary" id="connect-btn">Connect Wallet</button>
            </div>
        </div>

        <div id="stake-section" class="card hidden" style="margin-top: 16px;">
            <div id="status-msg" class="status hidden"></div>

            <div class="pending-rewards">
                <div class="pending-value" id="pending-rewards">0.0000 USDT</div>
                <div class="pending-label">Pending Rewards</div>
            </div>
            <button class="btn btn-primary" id="harvest-btn">Harvest Rewards</button>

            <h3 class="section-title">Your Position</h3>
            <div class="stats-grid">
                <div class="stat">
                    <div class="stat-value" id="user-staked">0.00</div>
                    <div class="stat-label">TCu29-USDT Staked</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="user-share">0.00%</div>
                    <div class="stat-label">Pool Share</div>
                </div>
            </div>

            <h3 class="section-title">Stake TCu29-USDT Tokens</h3>
            <div class="input-group">
                <div class="input-wrapper">
                    <input type="number" id="deposit-amount" placeholder="0.0" step="any">
                    <button class="max-btn" id="deposit-max-btn">MAX</button>
                </div>
                <div class="balance-row">
                    <span>Balance:</span>
                    <span id="lp-balance">0.00 LP</span>
                </div>
            </div>
            <button class="btn btn-primary" id="deposit-btn">Deposit</button>

            <h3 class="section-title">Withdraw TCu29-USDT Tokens</h3>
            <div class="input-group">
                <div class="input-wrapper">
                    <input type="number" id="withdraw-amount" placeholder="0.0" step="any">
                    <button class="max-btn" id="withdraw-max-btn">MAX</button>
                </div>
                <div class="balance-row">
                    <span>Staked:</span>
                    <span id="staked-balance">0.00 LP</span>
                </div>
            </div>
            <button class="btn btn-secondary" id="withdraw-btn">Withdraw</button>
        </div>

        <div class="links">
            <a href="https://phemex.com/trade/TCU29-USDT" target="_blank">Buy TCu29</a>
            <a href="https://pancakeswap.finance/swap?outputCurrency=0x5b0B5c848a843c83c20dcfa25CDe6E122898a614" target="_blank">Swap for TCu29</a>
            <a href="https://pancakeswap.finance/add/0x5b0B5c848a843c83c20dcfa25CDe6E122898a614/0x55d398326f99059fF775485246999027B3197955" target="_blank">Get TCu29-USDT Tokens</a>
            <a href="https://bscscan.com/address/0x7Fe0EDcCd50A704D78EdA999607CA9B61BCafD0A#code" target="_blank">Contract</a>
            <a href="https://www.geckoterminal.com/bsc/pools/0xc4a13d9c061bb6fc254cc31d4737c6d5427b3aa8" target="_blank">Chart</a>
        </div>

        <div class="footer">
            <a href="https://tcu29.io" target="_blank">Learn more at TCu29.io</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
    <script>
        // Contract addresses
        const FARM_ADDRESS = "0x7Fe0EDcCd50A704D78EdA999607CA9B61BCafD0A";
        const LP_TOKEN_ADDRESS = "0xC4A13D9C061bb6FC254cc31d4737C6d5427B3aa8";
        const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";
        const PRICE_ORACLE_ADDRESS = "0x0F7b4081E023d5962A7CeA0C3530D5deb016779e";

        // ABIs
        const PRICE_ORACLE_ABI = [
            "function getPrice() view returns (uint256)",
            "function getLastUpdateTime() view returns (uint256)",
            "function getPriceHistory(uint256 count) view returns (uint256[] prices, uint256[] timestamps)"
        ];

        const FARM_ABI = [
            "function deposit(uint256 pid, uint256 amount) external",
            "function withdraw(uint256 pid, uint256 amount) external",
            "function harvest(uint256 pid) external",
            "function pendingReward(uint256 pid, address user) view returns (uint256)",
            "function userInfo(uint256 pid, address user) view returns (uint256 amount, uint256 rewardDebt)",
            "function getFarmInfo() view returns (uint256 totalStaked, uint256 rewardsPerDay, uint256 rewardsRemaining, uint256 endTime)",
            "function rewardPerSecond() view returns (uint256)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address account) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        const LP_ABI = [
            ...ERC20_ABI,
            "function totalSupply() view returns (uint256)"
        ];

        // State
        let provider, signer, userAddress;
        let farm, lpToken, usdt;

        // DOM elements
        const connectBtn = document.getElementById('connect-btn');
        const connectSection = document.getElementById('connect-section');
        const stakeSection = document.getElementById('stake-section');
        const statusMsg = document.getElementById('status-msg');

        // Initialize
        async function init() {
            await Promise.all([
                updateFarmStats(),
                updateCopperData()
            ]);
            setInterval(updateFarmStats, 30000);
            setInterval(updateCopperData, 300000); // Update every 5 mins
        }

        // Update copper price and chart from oracle
        async function updateCopperData() {
            try {
                const readProvider = new ethers.JsonRpcProvider('https://bsc-dataseed.binance.org/');
                const priceOracle = new ethers.Contract(PRICE_ORACLE_ADDRESS, PRICE_ORACLE_ABI, readProvider);

                // Get current price and history
                const [price, history] = await Promise.all([
                    priceOracle.getPrice(),
                    priceOracle.getPriceHistory(30) // Get last 30 data points
                ]);

                const priceFormatted = parseFloat(ethers.formatUnits(price, 18)).toFixed(2);
                document.getElementById('copper-price').textContent = '$' + priceFormatted;

                // Draw the chart
                drawPriceChart(history.prices, history.timestamps);
            } catch (error) {
                console.error('Failed to fetch copper data:', error);
            }
        }

        // Draw price chart on canvas
        function drawPriceChart(prices, timestamps) {
            const canvas = document.getElementById('price-chart');
            const ctx = canvas.getContext('2d');

            // Set canvas resolution for sharp rendering
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const width = rect.width;
            const height = rect.height;
            const padding = { top: 15, right: 15, bottom: 25, left: 45 };

            // Convert prices to numbers
            const priceData = prices.map(p => parseFloat(ethers.formatUnits(p, 18)));
            const timeData = timestamps.map(t => Number(t));

            if (priceData.length < 2) return;

            // Find min/max for scaling
            const minPrice = Math.min(...priceData) * 0.998;
            const maxPrice = Math.max(...priceData) * 1.002;
            const priceRange = maxPrice - minPrice || 0.1;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Draw Y-axis labels (dollar amounts)
            ctx.font = '10px -apple-system, sans-serif';
            ctx.fillStyle = '#92400e';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';

            const yTicks = 4;
            for (let i = 0; i <= yTicks; i++) {
                const price = minPrice + (priceRange * i / yTicks);
                const y = padding.top + chartHeight - (i / yTicks) * chartHeight;
                ctx.fillText('$' + price.toFixed(2), padding.left - 5, y);

                // Draw horizontal grid line
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.strokeStyle = 'rgba(146, 64, 14, 0.1)';
                ctx.lineWidth = 1;
                ctx.stroke();
            }

            // Draw X-axis labels (time marks every 2 hours)
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';

            const minTime = Math.min(...timeData);
            const maxTime = Math.max(...timeData);
            const timeRange = maxTime - minTime || 1;
            const twoHours = 2 * 60 * 60; // 2 hours in seconds

            // Find time marks at 2-hour intervals
            const startHour = Math.ceil(minTime / twoHours) * twoHours;
            for (let t = startHour; t <= maxTime; t += twoHours) {
                const x = padding.left + ((t - minTime) / timeRange) * chartWidth;
                if (x >= padding.left && x <= width - padding.right) {
                    const date = new Date(t * 1000);
                    const label = date.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
                    ctx.fillStyle = '#92400e';
                    ctx.fillText(label, x, height - padding.bottom + 5);

                    // Draw vertical grid line
                    ctx.beginPath();
                    ctx.moveTo(x, padding.top);
                    ctx.lineTo(x, height - padding.bottom);
                    ctx.strokeStyle = 'rgba(146, 64, 14, 0.1)';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }

            // Draw gradient background for chart area
            const gradient = ctx.createLinearGradient(0, padding.top, 0, height - padding.bottom);
            gradient.addColorStop(0, 'rgba(184, 115, 51, 0.15)');
            gradient.addColorStop(1, 'rgba(184, 115, 51, 0.02)');

            // Calculate points
            const points = priceData.map((price, i) => ({
                x: padding.left + ((timeData[i] - minTime) / timeRange) * chartWidth,
                y: padding.top + chartHeight - ((price - minPrice) / priceRange) * chartHeight
            }));

            // Draw filled area
            ctx.beginPath();
            ctx.moveTo(points[0].x, height - padding.bottom);
            points.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.lineTo(points[points.length - 1].x, height - padding.bottom);
            ctx.closePath();
            ctx.fillStyle = gradient;
            ctx.fill();

            // Draw line
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            points.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.strokeStyle = '#b87333';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Draw current price dot
            const lastPoint = points[points.length - 1];
            ctx.beginPath();
            ctx.arc(lastPoint.x, lastPoint.y, 4, 0, Math.PI * 2);
            ctx.fillStyle = '#b87333';
            ctx.fill();
            ctx.beginPath();
            ctx.arc(lastPoint.x, lastPoint.y, 6, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(184, 115, 51, 0.3)';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // Connect wallet
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    showStatus('Please install MetaMask or another Web3 wallet', 'error');
                    return;
                }

                // Request account access first
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (!accounts || accounts.length === 0) {
                    showStatus('No accounts found. Please unlock your wallet.', 'error');
                    return;
                }

                provider = new ethers.BrowserProvider(window.ethereum);

                // Check network (BSC = 56)
                const network = await provider.getNetwork();
                if (network.chainId !== 56n) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x38' }],
                        });
                        // Wait for network switch to complete
                        await new Promise(resolve => setTimeout(resolve, 500));
                        // Reinitialize provider after network switch
                        provider = new ethers.BrowserProvider(window.ethereum);
                    } catch (switchError) {
                        showStatus('Please switch to BSC network', 'error');
                        return;
                    }
                }

                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // Initialize contracts
                farm = new ethers.Contract(FARM_ADDRESS, FARM_ABI, signer);
                lpToken = new ethers.Contract(LP_TOKEN_ADDRESS, LP_ABI, signer);
                usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);

                // Update UI - ensure sections toggle correctly
                connectSection.classList.add('hidden');
                stakeSection.classList.remove('hidden');

                // Update user info immediately
                await updateUserInfo();

                // Start periodic updates if not already started
                if (!window.userInfoInterval) {
                    window.userInfoInterval = setInterval(updateUserInfo, 10000);
                }

            } catch (error) {
                console.error(error);
                showStatus('Failed to connect: ' + error.message, 'error');
            }
        }

        connectBtn.addEventListener('click', connectWallet);

        // Auto-connect if previously connected
        async function autoConnect() {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts && accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (e) {
                    console.log('Auto-connect not available');
                }
            }
        }

        // Try auto-connect after page loads
        setTimeout(autoConnect, 1000);

        // Update farm statistics
        async function updateFarmStats() {
            try {
                const readProvider = new ethers.JsonRpcProvider('https://bsc-dataseed.binance.org/');
                const farmRead = new ethers.Contract(FARM_ADDRESS, FARM_ABI, readProvider);
                const lpRead = new ethers.Contract(LP_TOKEN_ADDRESS, LP_ABI, readProvider);
                const usdtRead = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, readProvider);

                const [farmInfo, lpSupply, usdtInPool] = await Promise.all([
                    farmRead.getFarmInfo(),
                    lpRead.totalSupply(),
                    usdtRead.balanceOf(LP_TOKEN_ADDRESS)
                ]);

                const [totalStaked, rewardsPerDay] = farmInfo;

                // Calculate LP price (2 * USDT reserve / total supply)
                const poolTVL = usdtInPool * 2n;
                const lpPrice = lpSupply > 0n ? poolTVL * BigInt(1e18) / lpSupply : 0n;

                // Calculate TVL
                const tvl = totalStaked * lpPrice / BigInt(1e18);

                // Calculate APR
                const annualRewards = rewardsPerDay * 365n;
                const apr = tvl > 0n ? (annualRewards * 100n * BigInt(1e18)) / tvl : 0n;

                // Update UI
                document.getElementById('tvl').textContent = '$' + formatNumber(ethers.formatUnits(tvl, 18), 2);
                document.getElementById('apr').textContent = formatNumber(ethers.formatUnits(apr, 18), 0) + '%';

            } catch (error) {
                console.error('Failed to update farm stats:', error);
            }
        }

        // Update user info
        async function updateUserInfo() {
            if (!userAddress) return;

            try {
                const [userInfo, lpBalance, pending, farmInfo] = await Promise.all([
                    farm.userInfo(0, userAddress),
                    lpToken.balanceOf(userAddress),
                    farm.pendingReward(0, userAddress),
                    farm.getFarmInfo()
                ]);

                const [userStaked] = userInfo;
                const [totalStaked] = farmInfo;

                const share = totalStaked > 0n ? (userStaked * 10000n / totalStaked) : 0n;

                document.getElementById('user-staked').textContent = formatNumber(ethers.formatUnits(userStaked, 18), 4);
                document.getElementById('staked-balance').textContent = formatNumber(ethers.formatUnits(userStaked, 18), 4) + ' LP';
                document.getElementById('lp-balance').textContent = formatNumber(ethers.formatUnits(lpBalance, 18), 4) + ' LP';
                document.getElementById('user-share').textContent = (Number(share) / 100).toFixed(2) + '%';
                document.getElementById('pending-rewards').textContent = formatNumber(ethers.formatUnits(pending, 18), 6) + ' USDT';

                // Store for max buttons
                window.userLpBalance = lpBalance;
                window.userStaked = userStaked;

            } catch (error) {
                console.error('Failed to update user info:', error);
            }
        }

        // Deposit
        document.getElementById('deposit-btn').addEventListener('click', async () => {
            const amount = document.getElementById('deposit-amount').value;
            if (!amount || parseFloat(amount) <= 0) {
                showStatus('Enter an amount', 'error');
                return;
            }

            try {
                const amountWei = ethers.parseUnits(amount, 18);

                // Check allowance
                const allowance = await retryTransaction(() => lpToken.allowance(userAddress, FARM_ADDRESS));
                if (allowance < amountWei) {
                    showStatus('Approving LP tokens...', 'pending');
                    const approveTx = await retryTransaction(() => lpToken.approve(FARM_ADDRESS, amountWei));
                    await approveTx.wait();
                }

                showStatus('Depositing...', 'pending');
                const tx = await retryTransaction(() => farm.deposit(0, amountWei));
                await tx.wait();

                showStatus('Deposit successful!', 'success');
                document.getElementById('deposit-amount').value = '';
                await updateUserInfo();
                await updateFarmStats();

            } catch (error) {
                console.error(error);
                showStatus('Deposit failed: ' + formatError(error), 'error');
            }
        });

        // Withdraw
        document.getElementById('withdraw-btn').addEventListener('click', async () => {
            const amount = document.getElementById('withdraw-amount').value;
            if (!amount || parseFloat(amount) <= 0) {
                showStatus('Enter an amount', 'error');
                return;
            }

            try {
                const amountWei = ethers.parseUnits(amount, 18);

                showStatus('Withdrawing...', 'pending');
                const tx = await retryTransaction(() => farm.withdraw(0, amountWei));
                await tx.wait();

                showStatus('Withdraw successful!', 'success');
                document.getElementById('withdraw-amount').value = '';
                await updateUserInfo();
                await updateFarmStats();

            } catch (error) {
                console.error(error);
                showStatus('Withdraw failed: ' + formatError(error), 'error');
            }
        });

        // Harvest
        document.getElementById('harvest-btn').addEventListener('click', async () => {
            try {
                showStatus('Harvesting rewards...', 'pending');
                const tx = await retryTransaction(() => farm.harvest(0));
                await tx.wait();

                showStatus('Harvest successful!', 'success');
                await updateUserInfo();

            } catch (error) {
                console.error(error);
                showStatus('Harvest failed: ' + formatError(error), 'error');
            }
        });

        // Max buttons
        document.getElementById('deposit-max-btn').addEventListener('click', () => {
            if (window.userLpBalance) {
                document.getElementById('deposit-amount').value = ethers.formatUnits(window.userLpBalance, 18);
            }
        });

        document.getElementById('withdraw-max-btn').addEventListener('click', () => {
            if (window.userStaked) {
                document.getElementById('withdraw-amount').value = ethers.formatUnits(window.userStaked, 18);
            }
        });

        // Retry helper for rate-limited transactions
        async function retryTransaction(fn, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    const isRateLimit = error.message?.includes('rate limit') ||
                                       error.message?.includes('Rate limit') ||
                                       error.code === -32603;
                    if (isRateLimit && i < maxRetries - 1) {
                        showStatus(`Rate limited, retrying in ${(i + 1) * 2}s...`, 'pending');
                        await new Promise(r => setTimeout(r, (i + 1) * 2000));
                        continue;
                    }
                    throw error;
                }
            }
        }

        // Format error message for display
        function formatError(error) {
            if (error.message?.includes('rate limit') || error.message?.includes('Rate limit')) {
                return 'RPC rate limited. Please wait a moment and try again.';
            }
            if (error.message?.includes('user rejected')) {
                return 'Transaction cancelled by user.';
            }
            return error.reason || error.shortMessage || error.message || 'Unknown error';
        }

        // Helpers
        function showStatus(message, type) {
            statusMsg.textContent = message;
            statusMsg.className = 'status ' + type;
            statusMsg.classList.remove('hidden');

            if (type === 'success') {
                setTimeout(() => statusMsg.classList.add('hidden'), 5000);
            }
        }

        function formatNumber(num, decimals) {
            const n = parseFloat(num);
            if (isNaN(n)) return '0';
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(2) + 'K';
            return n.toFixed(decimals);
        }

        // Handle account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => window.location.reload());
            window.ethereum.on('chainChanged', () => window.location.reload());
        }

        // Start
        init();
    </script>
</body>
</html>
